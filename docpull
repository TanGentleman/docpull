#!/usr/bin/env bash
# Wrapper script for docpull CLI
# Works from any directory, with or without uv, with or without activated venv

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Add project to Python path for module imports (needed if not installed as package)
export PYTHONPATH="${SCRIPT_DIR}${PYTHONPATH:+:$PYTHONPATH}"

if command -v uv &> /dev/null; then
    # Use uv run with --directory to change to project dir for proper env resolution
    # This ensures uv uses the project's .venv regardless of current directory or VIRTUAL_ENV
    exec uv run --directory "$SCRIPT_DIR" python -m cli.main "$@"
else
    # For non-uv users: check if project venv exists
    if [[ ! -d "$SCRIPT_DIR/.venv" ]]; then
        echo "Error: No virtual environment found at $SCRIPT_DIR/.venv" >&2
        echo "Please run: python -m venv $SCRIPT_DIR/.venv && source $SCRIPT_DIR/.venv/bin/activate && pip install -e $SCRIPT_DIR" >&2
        exit 1
    fi
    
    # Use the project's Python directly (avoids venv activation conflicts)
    exec "$SCRIPT_DIR/.venv/bin/python" -m cli.main "$@"
fi
