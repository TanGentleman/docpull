#!/usr/bin/env bash
set -e

# Docpull Installation Script
# Handles venv setup, dependency installation, modal configuration, and deployment

echo "ğŸ”§ Docpull Installation"
echo "=" | awk '{printf "=%.0s", $0; for(i=1;i<=59;i++) printf "="}; {print ""}'

# Step 1: Setup virtual environment
echo ""
echo "ğŸ“¦ Setting up virtual environment..."

# Check if uv is available
if command -v uv &> /dev/null; then
    echo "âœ“ Found uv, using uv sync for faster setup"

    # Check if pyproject.toml exists for uv sync
    if [ -f "pyproject.toml" ]; then
        uv sync
    else
        # Fallback: use uv to create venv and install from requirements.txt
        if [ ! -d ".venv" ]; then
            uv venv .venv
        fi
        source .venv/bin/activate
        uv pip install -r requirements.txt
    fi

    # Activate venv created by uv
    source .venv/bin/activate
else
    echo "âœ“ Using standard Python venv"

    # Create venv if it doesn't exist
    if [ ! -d ".venv" ]; then
        python3 -m venv .venv
    fi

    # Activate venv
    source .venv/bin/activate

    # Upgrade pip
    python -m pip install --upgrade pip --quiet

    # Install dependencies
    echo "ğŸ“¥ Installing dependencies from requirements.txt..."
    pip install -r requirements.txt --quiet
fi

echo "âœ… Virtual environment ready"

# Step 2: Check Modal configuration
echo ""
echo "ğŸ”‘ Checking Modal authentication..."

# Try to check modal token status
if ! python -m modal token show &> /dev/null; then
    echo "âš ï¸  Modal not authenticated"
    echo ""
    echo "Please authenticate with Modal:"
    echo "  modal token set"
    echo ""
    read -p "Press Enter after authenticating with Modal, or Ctrl+C to exit..."

    # Verify authentication worked
    if ! python -m modal token show &> /dev/null; then
        echo "âŒ Modal authentication failed"
        exit 1
    fi
fi

echo "âœ… Modal authenticated"

# Step 3: Deploy to Modal
echo ""
echo "ğŸš€ Deploying to Modal..."
echo ""

# Run setup.py deployment
python setup.py

echo ""
echo "=" | awk '{printf "=%.0s", $0; for(i=1;i<=59;i++) printf "="}; {print ""}'
echo "âœ… Installation complete!"
echo ""
echo "To run the web UI installer in the future:"
echo "  source .venv/bin/activate"
echo "  cd setup && python server.py"
echo ""
echo "To use the CLI:"
echo "  source .venv/bin/activate"
echo "  python cli/main.py sites"
echo "=" | awk '{printf "=%.0s", $0; for(i=1;i<=59;i++) printf "="}; {print ""}'
